<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>DASBEM Loader</title>
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700&family=Poppins:wght@300;500;700&display=swap" rel="stylesheet">
<style>
:root{
  --bg-dark:#1a1a1a;
  --text-light:#fff;
  --glass: rgba(255,255,255,0.12);
  --accent:#ffb347;
  --muted:#ddd;
}

*{box-sizing:border-box;}
html,body{margin:0;padding:0;font-family:"Poppins",sans-serif;background:var(--bg-dark);color:var(--text-light);overflow:hidden;width:100%;height:100%;}

/* ===== Loader Container ===== */
#loaderApp{position:fixed;inset:0;display:flex;flex-direction:column;padding:16px;gap:10px;background:var(--bg-dark);z-index:9999;}
#loaderHeader{font-family:'Playfair Display',serif;color:var(--accent);font-size:1.5rem;letter-spacing:1px;margin-bottom:6px;}
.viewportWrap{flex:1;display:flex;flex-direction:column;gap:8px;min-height:120px;}
.viewport{flex:1;overflow-y:auto;padding:10px 12px;background:var(--glass);border-radius:8px;box-shadow:inset 0 6px 18px rgba(0,0,0,0.6);}
.logLine{font-family:"Poppins",monospace;font-size:12.8px;line-height:1.28;margin:4px 0;opacity:0;transform:translateY(6px);transition:opacity .12s linear, transform .12s linear;white-space:pre-wrap;word-break:break-word;color:var(--text-light);}
.logLine.visible{opacity:1;transform:translateY(0);}
.meta{color:var(--muted);display:inline-block;width:80px;font-size:12px;margin-right:8px;}
.finalLine{color:var(--accent);font-weight:700;font-size:14px;margin-top:8px;padding:6px;border-radius:6px;background:rgba(255,179,71,0.06);}
.progressWrap{height:12px;background:var(--glass);border-radius:8px;overflow:hidden;border:1px solid rgba(255,255,255,0.1);}
.progressBar{height:100%;width:0;background:var(--accent);transition:width 60ms linear;}

/* faint grid background */
.grid{pointer-events:none;position:fixed;inset:0;z-index:0;background-image:linear-gradient(rgba(255,255,255,0.02) 1px, transparent 1px);background-size:22px 22px;opacity:0.03;}

/* glitch effect */
.glitch{animation:glitchShift 80ms linear}
@keyframes glitchShift{0%{transform:translateX(0) skewX(0deg);opacity:1}50%{transform:translateX(-4px) skewX(-1deg);opacity:0.95}100%{transform:translateX(2px) skewX(0.5deg);opacity:1}}
</style>
</head>
<body>
<div class="grid" aria-hidden="true"></div>
<div id="loaderApp">
  <div id="loaderHeader">DASBEM Initialization...</div>
  <div class="viewportWrap">
    <div class="viewport" id="viewport" role="region" aria-label="Loader log"></div>
    <div class="progressWrap" aria-label="Loading progress">
      <div class="progressBar" id="progressBar"></div>
    </div>
  </div>
</div>

<script>
const TOTAL_DURATION = 3000; // 3s
const TOTAL_LINES = 800;     // very dense
const REDIRECT = "index.html";
const viewport = document.getElementById('viewport');
const progressBar = document.getElementById('progressBar');
const header = document.getElementById('loaderHeader');

function timeStamp(){
  const now = new Date();
  const t = now;
  return `[${String(t.getHours()).padStart(2,'0')}:${String(t.getMinutes()).padStart(2,'0')}:${String(t.getSeconds()).padStart(2,'0')}]`;
}

const templates = [
  "Loading module core.{m} ...",
  "Initializing subroutine {sub} ...",
  "Reading mesh file {mesh} ...",
  "Allocating memory block [{blk}] ...",
  "Computing convolution block #{blk} ...",
  "Applying boundary condition: {bc} ...",
  "Synchronizing solver threads (rank {r}) ...",
  "Writing snapshot /output/snap_{id}.bin ...",
  "Loading topography '{topo}' ...",
  "Merging subdomain results (sd={sd}) ...",
  "Estimating memory usage ({mem} MB) ...",
];

function rnd(a,b){ return Math.floor(Math.random()*(b-a+1))+a; }
function pick(a){ return a[Math.floor(Math.random()*a.length)]; }

function fillToken(tok){
  switch(tok){
    case 'm': return pick(['core','conv','io','solver']);
    case 'sub': return pick(['time_step','conv_kernel','io_worker']);
    case 'mesh': return `mesh_${rnd(10,999)}.msh`;
    case 'blk': return rnd(1,256);
    case 'bc': return pick(['free-surface','non-reflective','absorbing']);
    case 'r': return rnd(0,31);
    case 'id': return rnd(100000,999999);
    case 'topo': return 'topo_'+rnd(1,99)+'.dat';
    case 'sd': return rnd(1,64);
    case 'mem': return rnd(64,65536);
    default: return '';
  }
}

function fillTemplate(tpl){
  return tpl.replace(/\{([^\}]+)\}/g, (_, token)=> fillToken(token));
}

const timestamps = (function(){
  const arr = [];
  for(let i=0;i<TOTAL_LINES;i++){
    const base = (i / (TOTAL_LINES)) * TOTAL_DURATION;
    const jitter = (1 - i/TOTAL_LINES) * 25;
    arr.push(Math.max(0, Math.round(base + (Math.random()*2-1)*jitter)));
  }
  arr[TOTAL_LINES-1] = TOTAL_DURATION - 60;
  return arr;
})();

function pushLine(text, important=false){
  const row = document.createElement('div');
  row.className = 'logLine';
  const meta = document.createElement('span');
  meta.className = 'meta';
  meta.textContent = timeStamp();
  const txt = document.createElement('span');
  txt.textContent = ' ' + text;
  row.appendChild(meta);
  row.appendChild(txt);
  viewport.appendChild(row);
  while(viewport.children.length>400) viewport.removeChild(viewport.children[0]);
  requestAnimationFrame(()=> row.classList.add('visible'));
  viewport.scrollTop = viewport.scrollHeight;
  if(important) row.classList.add('finalLine');
  return row;
}

let startedAt = performance.now();
function updateProgress(){
  const elapsed = performance.now() - startedAt;
  const pct = Math.min(100,(elapsed/TOTAL_DURATION)*100);
  progressBar.style.width = pct + '%';
}

function start(){
  startedAt = performance.now();
  updateProgress();
  for(let i=0;i<TOTAL_LINES;i++){
    setTimeout(((idx)=>{
      return function(){
        const tpl = pick(templates);
        const line = fillTemplate(tpl);
        pushLine(line);
      };
    })(i), timestamps[i]);
  }
  setTimeout(()=> { pushLine("âœ” Software successfully launched.", true); }, TOTAL_DURATION);
  const pUp = setInterval(()=> updateProgress(),20);
  setTimeout(()=> { clearInterval(pUp); progressBar.style.width='100%'; setTimeout(()=>{window.location.href=REDIRECT;},400);}, TOTAL_DURATION+300);
}
start();
</script>
</body>
</html>
