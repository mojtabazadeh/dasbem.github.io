<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>DASBEM Loader</title>
<link href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&display=swap" rel="stylesheet">
<style>
  :root{
    --bg:#1e1f22;       /* dark gray terminal-like */
    --panel:#27292c;    /* slightly lighter panel */
    --text:#e6eef0;     /* soft white text */
    --muted:#9aa4a6;    /* muted text */
    --accent:#7fe0b8;   /* soft green for technical text */
    --gold:#ffcc66;     /* final success color */
    --progressA:#b46b00;
    --progressB:#ffcc66;
  }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;background:var(--bg);color:var(--text);font-family:'Share Tech Mono',monospace;overflow:hidden}
  #app{position:relative;height:100%;width:100%;display:flex;flex-direction:column;padding:18px;gap:12px}

  /* header */
  #header{
    font-size:15px;
    color:var(--muted);
    letter-spacing:0.6px;
    user-select:none;
    max-width:100%;
    overflow:hidden;
    white-space:nowrap;
  }

  /* viewport panel */
  .viewportWrap{
    flex:1;
    display:flex;
    flex-direction:column;
    gap:8px;
    min-height:120px;
  }

  .viewport{
    flex:1;
    overflow-y:auto;
    padding:12px;
    background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0));
    border-radius:8px;
    border:1px solid rgba(255,255,255,0.03);
    box-shadow: inset 0 4px 14px rgba(0,0,0,0.6);
  }

  .logLine{
    font-size:13px;
    line-height:1.25;
    margin:6px 0;
    opacity:0;
    transform:translateY(6px);
    transition:opacity .12s linear, transform .12s linear;
    white-space:pre-wrap;
    color:var(--text);
  }
  .logLine.visible{opacity:1; transform:translateY(0);}

  .logMeta{ color: var(--muted); margin-right:8px; display:inline-block; width:88px; font-size:12px; }

  .finalLine{
    color:var(--gold);
    font-weight:700;
    font-size:15px;
    text-shadow:0 0 8px rgba(255,204,102,0.06);
    margin-top:8px;
    padding:8px;
    border-radius:6px;
    background:linear-gradient(90deg, rgba(255,204,102,0.03), transparent);
  }

  /* progress */
  .progressWrap{height:14px;background:var(--panel);border-radius:8px;overflow:hidden;border:1px solid rgba(255,255,255,0.03);display:block}
  .progressBar{height:100%;width:0;background:linear-gradient(90deg,var(--progressA),var(--progressB));transition:width 60ms linear}

  /* subtle background pattern */
  .grid{
    pointer-events:none;
    position:fixed;inset:0;z-index:0;
    background-image:
      linear-gradient(rgba(255,255,255,0.01) 1px, transparent 1px);
    background-size:22px 22px;
    opacity:0.04;
  }

  /* mobile tweaks */
  @media (max-width:640px){
    #app{padding:12px}
    #header{font-size:13px}
    .logLine{font-size:12px;margin:6px 0}
    .progressWrap{height:12px;border-radius:7px}
    .logMeta{width:72px;font-size:11px}
  }
</style>
</head>
<body>
  <div class="grid" aria-hidden="true"></div>

  <div id="app" role="main" aria-live="polite">
    <div id="header">DASBEM Time-Domain Solver v3.2 — Initializing...</div>

    <div class="viewportWrap">
      <div class="viewport" id="viewport" role="region" aria-label="Loader log"></div>
      <div class="progressWrap" aria-hidden="false" aria-label="Loading progress">
        <div class="progressBar" id="progressBar"></div>
      </div>
    </div>
  </div>

<script>
/* ---------- Settings ---------- */
const TOTAL_DURATION = 3000; // 3 seconds total
const TOTAL_LINES = 220;     // enough lines to feel dense but finish in time
const REDIRECT = "index.html";

/* ---------- Time helper (Tehran-style timestamps) ---------- */
function timeStamp(){
  const now = new Date();
  const utc = now.getTime() + now.getTimezoneOffset()*60000;
  const t = new Date(utc + 3.5*3600*1000);
  return `[${String(t.getHours()).padStart(2,'0')}:${String(t.getMinutes()).padStart(2,'0')}:${String(t.getSeconds()).padStart(2,'0')}]`;
}

/* ---------- DOM refs ---------- */
const viewport = document.getElementById('viewport');
const progressBar = document.getElementById('progressBar');

/* ---------- Realistic phrase generation (no line numbers) ---------- */
const templates = [
  "Allocating half-space Green's functions kernel for element {eid}",
  "Assembling time-domain BIE coefficients (node {nid} → block {bid})",
  "Computing transient SH-wave convolution (t-step {ts})",
  "Applying free-surface boundary condition at patch {pid}",
  "Evaluating elastodynamic influence matrix row {rid}",
  "Performing LU factorization on influence block {bid}",
  "Optimizing recursive convolution window (window={win}ms)",
  "Integrating fundamental solution with Gaussian points={gq}",
  "Synchronizing subdomain solvers (threads={th})",
  "Updating displacement vector for DOF {dof}",
  "Transforming boundary coordinates (rot={rot} deg)",
  "Validating half-space radiation condition (tol={tol})",
  "Performing domain decomposition: subdomain {sd} of {sdn}",
  "Generating stiffness submatrix (nnz={nnz})",
  "Applying DASBEM recursive time-step solver (dt={dt}ms)",
  "Calculating amplification factor at station {st}",
  "Evaluating convolution memory usage ({mem} MB)",
  "Storing response snapshot to /output/resp_{idx}.bin",
  "Post-processing spectral amplification (freq={f}Hz)",
  "Exporting motion history segment (len={len} samples)",
  "Initializing numerical kernel module '{mod}'",
  "Loading boundary element matrix '{mat}'",
  "Updating convolution integrals chunk #{chunk}",
  "Optimizing matrix-vector product for band={band}",
  "Applying non-reflective boundary at edge {edge}",
  "Finalizing recursive cycle {cycle}",
  "Assembling half-space influence matrices",
  "Calculating displacement & stress response at node {nid}",
  "Synchronizing global time-stepping (step {s} of {S})",
  "Generating output file /output/DASBEM_run_{run}.dat",
  "Validating solver stability (CFL={cfl})",
  "Performing quadrature integration (order={ord})",
  "Transforming results to local coordinate system '{sys}'",
  "Validating HSTD-BEM residual (res={res})",
  "Performing boundary kernel update (alpha={a})",
  "Evaluating dynamic equilibrium (err={err})",
  "Optimizing memory allocation (heap={heap}MB)",
  "Post-processing amplification map tile {tx},{ty}",
  "Storing SH-wave field history frame {frm}",
  "Applying domain constraints set {set}",
  "Computing influence coefficients for nodes {r0}-{r1}",
  "Finalizing computational kernel pass {pass}"
];

function rnd(a,b){ return Math.floor(Math.random()*(b-a+1))+a; }
function pick(a){ return a[Math.floor(Math.random()*a.length)]; }

function fillTemplate(tpl){
  return tpl.replace(/\{([^\}]+)\}/g, (_, token)=>{
    switch(token){
      case 'eid': return 'E'+rnd(1000,9999);
      case 'nid': return 'N'+rnd(10,9999);
      case 'bid': return 'B'+rnd(1,99);
      case 'ts': return rnd(0,1200);
      case 'pid': return 'P'+rnd(1,999);
      case 'rid': return 'R'+rnd(100,9999);
      case 'win': return rnd(10,800);
      case 'gq': return rnd(8,48);
      case 'th': return rnd(1,16);
      case 'dof': return rnd(1,6)+'-'+rnd(10,999);
      case 'rot': return (Math.random()*360).toFixed(1);
      case 'tol': return (Math.random()*1e-3).toExponential(2);
      case 'sd': return rnd(1,32);
      case 'sdn': return rnd(32,256);
      case 'nnz': return rnd(10,1200);
      case 'dt': return (Math.random()*5+0.05).toFixed(3);
      case 'st': return 'STA'+rnd(1,999);
      case 'mem': return rnd(4,2048);
      case 'idx': return rnd(100000,999999);
      case 'f': return (Math.random()*20+0.1).toFixed(2);
      case 'len': return rnd(256,65536);
      case 'mod': return pick(['core','conv','kern','io','solver','post']);
      case 'mat': return 'mat_'+rnd(100,999);
      case 'chunk': return rnd(1,9999);
      case 'band': return rnd(1,24);
      case 'edge': return rnd(0,7);
      case 'cycle': return rnd(1,12);
      case 's': return rnd(1,999);
      case 'S': return rnd(100,1200);
      case 'run': return rnd(1000,9999);
      case 'cfl': return (Math.random()*0.5+0.05).toFixed(3);
      case 'ord': return rnd(3,12);
      case 'sys': return pick(['local','global','geo']);
      case 'res': return (Math.random()*1e-2).toFixed(5);
      case 'a': return (Math.random()).toFixed(3);
      case 'err': return (Math.random()*1e-4).toExponential(2);
      case 'heap': return rnd(128,65536);
      case 'tx': return rnd(0,12);
      case 'ty': return rnd(0,12);
      case 'frm': return rnd(0,99999);
      case 'set': return 'BSET'+rnd(1,99);
      case 'r0': return rnd(1,400);
      case 'r1': return rnd(401,800);
      case 'pass': return rnd(1,8);
      default: return '';
    }
  });
}

/* ---------- Schedule generation: spread TOTAL_LINES over TOTAL_DURATION with jitter ---------- */
const timestamps = (() => {
  const out = [];
  for(let i=0;i<TOTAL_LINES;i++){
    const base = (i / TOTAL_LINES) * TOTAL_DURATION;
    const jitter = (1 - i/TOTAL_LINES) * 22; // early lines can have more jitter
    out.push(Math.max(0, Math.round(base + (Math.random()*2-1) * jitter)));
  }
  out[TOTAL_LINES-1] = TOTAL_DURATION - 60;
  return out;
})();

/* ---------- Push line to viewport (adds meta timestamp like a terminal) ---------- */
function pushLine(text, isFinal=false){
  const row = document.createElement('div');
  row.className = 'logLine';
  const meta = document.createElement('span');
  meta.className = 'logMeta';
  meta.textContent = timeStamp();
  const content = document.createElement('span');
  content.textContent = ' ' + text;
  // slight color for technical keywords
  content.innerHTML = content.textContent
    .replace(/\b(Allocating|Assembling|Computing|Applying|Evaluating|Finalizing|Storing|Exporting|Initializing|Loading|Optimizing)\b/g,
             '<span style="color:var(--accent)">$&</span>');
  row.appendChild(meta);
  row.appendChild(content);
  viewport.appendChild(row);
  // cap lines
  while(viewport.children.length > 220) viewport.removeChild(viewport.children[0]);
  // animate in
  requestAnimationFrame(()=> row.classList.add('visible'));
  viewport.scrollTop = viewport.scrollHeight;
  if(isFinal){
    row.classList.add('finalLine');
  }
  return row;
}

/* ---------- Progress update based on real time ---------- */
let start = performance.now();
function tickProgress(){
  const elapsed = performance.now() - start;
  const pct = Math.min(100, (elapsed / TOTAL_DURATION) * 100);
  progressBar.style.width = pct + '%';
}

/* ---------- Launch emission according to timestamps ---------- */
function start(){
  start = performance.now();
  tickProgress();
  for(let i=0;i<TOTAL_LINES;i++){
    setTimeout(((idx)=>{
      return function(){
        const tpl = pick(templates);
        const line = fillTemplate(tpl);
        pushLine(line);
        // occasionally add a small 'checkpoint' log to feel real
        if(Math.random() < 0.012){
          const cp = pushLine("Committing checkpoint and flushing I/O buffers", true);
          cp.style.background = 'linear-gradient(90deg, rgba(255,204,102,0.03), transparent)';
        }
      };
    })(i), timestamps[i]);
  }

  // final message a bit before end
  setTimeout(()=> {
    pushLine("DASBEM protocol engaged.", true);
  }, Math.max(TOTAL_DURATION - 360, timestamps[TOTAL_LINES-1]));

  // progress updater
  const up = setInterval(()=> {
    tickProgress();
  }, 20);

  // after total duration + small hold -> redirect
  setTimeout(()=> {
    clearInterval(up);
    progressBar.style.width = '100%';
    // subtle success flash
    const flash = document.createElement('div');
    flash.style.position = 'fixed';
    flash.style.inset = 0;
    flash.style.pointerEvents = 'none';
    flash.style.background = 'radial-gradient(circle at 50% 10%, rgba(255,220,120,0.06), rgba(0,0,0,0))';
    flash.style.opacity = 0;
    flash.style.transition = 'opacity 220ms ease-out';
    document.body.appendChild(flash);
    requestAnimationFrame(()=> flash.style.opacity = 1);
    setTimeout(()=> flash.style.opacity = 0, 220);
    setTimeout(()=> { try{ window.location.href = REDIRECT; } catch(e){} }, 420);
  }, TOTAL_DURATION + 220);
}

/* kick off */
start();

/* optional: allow tap to skip */
document.getElementById('header').addEventListener('click', ()=>{
  pushLine("User skip requested — entering main interface.", true);
  progressBar.style.width = '100%';
  setTimeout(()=> { window.location.href = REDIRECT; }, 260);
});
</script>
</body>
</html>
