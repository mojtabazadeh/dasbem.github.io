<!-- ======= BEM-Seismic Terminal Loader ======= -->
<div id="siteLoader">
  <canvas id="bemCanvas"></canvas>
  <div class="terminal">
    <span class="prompt">&gt;</span>
    <span class="text" id="loaderText"></span>
    <span class="cursor"></span>
  </div>
</div>

<style>
:root {
  --bg-dark: #1a1a1a;
  --accent: #ffb347;
  --text-light: #fff;
}

/* Loader container */
#siteLoader {
  position: fixed;
  inset: 0;
  background: var(--bg-dark);
  display: flex;
  justify-content: center;
  align-items: center;
  z-index: 9999;
  overflow: hidden;
}

/* Canvas */
#bemCanvas {
  position: absolute;
  inset: 0;
  width: 100%;
  height: 100%;
  display: block;
}

/* Terminal text */
#siteLoader .terminal {
  position: relative;
  z-index: 2;
  font-family: 'Fira Code', monospace;
  font-size: 1.4rem;
  color: var(--text-light);
  display: flex;
  align-items: center;
}

#siteLoader .prompt {
  color: var(--accent);
  margin-right: 8px;
  text-shadow: 0 0 8px rgba(255,180,120,0.6);
}

#siteLoader .cursor {
  display: inline-block;
  width: 10px;
  height: 22px;
  background: var(--accent);
  margin-left: 4px;
  border-radius: 2px;
  animation: blink 0.8s infinite alternate;
  box-shadow: 0 0 6px rgba(255,180,120,0.5);
}

@keyframes blink {
  0% {opacity:1;}
  100% {opacity:0.2;}
}
</style>

<script>
// ===== Typing Terminal Text =====
document.addEventListener('DOMContentLoaded', () => {
  const textElement = document.getElementById('loaderText');
  const message = 'Initializing DASBEM Project... Solving BEM Equations...';
  let i = 0;
  function type() {
    if (i < message.length) {
      textElement.textContent += message.charAt(i);
      i++;
      setTimeout(type, 50); // سرعت تایپ
    }
  }
  type();
});

// ===== BEM + Seismic Grid Canvas =====
(function(){
  const canvas = document.getElementById('bemCanvas');
  const ctx = canvas.getContext('2d');
  let width = canvas.width = window.innerWidth;
  let height = canvas.height = window.innerHeight;

  // Grid setup
  const gridSize = 40; // فاصله خطوط شبکه
  const points = [];
  for(let y=0; y<=height; y+=gridSize){
    for(let x=0; x<=width; x+=gridSize){
      points.push({x, y, offsetY: 0});
    }
  }

  // Wave variables
  let waves = [];

  function createWave(){
    waves.push({
      x: Math.random()*width,
      y: height,
      radius: 0,
      maxRadius: Math.random()*200+150,
      speed: 2 + Math.random()*1,
      amplitude: 6 + Math.random()*4
    });
  }

  function drawGrid(){
    ctx.clearRect(0,0,width,height);
    
    // Draw grid lines
    ctx.strokeStyle = 'rgba(255,179,71,0.25)';
    ctx.lineWidth = 1;
    
    for(let y=0; y<=height; y+=gridSize){
      ctx.beginPath();
      for(let x=0; x<=width; x+=gridSize){
        let p = points.find(pt => pt.x === x && pt.y === y);
        let shake = Math.sin((y + Date.now()/200) / 15) * 1.5;
        ctx.lineTo(x, y + shake + (p? p.offsetY : 0));
      }
      ctx.stroke();
    }
    for(let x=0; x<=width; x+=gridSize){
      ctx.beginPath();
      for(let y=0; y<=height; y+=gridSize){
        let p = points.find(pt => pt.x === x && pt.y === y);
        let shake = Math.sin((x + Date.now()/200) / 15) * 1.5;
        ctx.lineTo(x, y + shake + (p? p.offsetY : 0));
      }
      ctx.stroke();
    }

    // Draw waves
    waves.forEach((w, idx)=>{
      ctx.beginPath();
      ctx.arc(w.x, w.y, w.radius, 0, Math.PI*2);
      ctx.strokeStyle = `rgba(255,179,71,${1-w.radius/w.maxRadius})`;
      ctx.lineWidth = 2;
      ctx.stroke();

      // Affect nearby points (shake)
      points.forEach(p=>{
        let dx = p.x - w.x;
        let dy = p.y - w.y;
        let dist = Math.hypot(dx,dy);
        if(dist < w.radius){
          let effect = Math.sin((w.radius - dist)/10) * w.amplitude;
          p.offsetY = effect;
        }
      });

      w.radius += w.speed;
      if(w.radius > w.maxRadius) waves.splice(idx,1);
    });
    
    requestAnimationFrame(drawGrid);
  }

  // Periodically add waves
  setInterval(createWave, 800);

  // Resize handler
  window.addEventListener('resize', ()=>{
    width = canvas.width = window.innerWidth;
    height = canvas.height = window.innerHeight;
    points.length = 0;
    for(let y=0; y<=height; y+=gridSize){
      for(let x=0; x<=width; x+=gridSize){
        points.push({x, y, offsetY: 0});
      }
    }
  });

  drawGrid();
})();

// ===== Loader fade out =====
window.addEventListener('load', () => {
  const loader = document.getElementById('siteLoader');
  setTimeout(()=>{
    loader.style.transition = 'opacity 1s ease';
    loader.style.opacity = '0';
    setTimeout(()=>loader.remove(),1000);
  }, 5000); // 5 ثانیه لودر
});
</script>
