<!doctype html>
<html lang="fa" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>DASBEM — Real Loader</title>
<link href="https://fonts.googleapis.com/css2?family=Fira+Code:wght@400;700&display=swap" rel="stylesheet">
<style>
:root{
  --bg:#050608;
  --panel:#0b0f12;
  --accent:#ffb347;
  --muted:#9aa6ad;
  --text:#e6f3ef;
}

/* base reset */
*{box-sizing:border-box}
html,body{height:100%;margin:0;background:var(--bg);font-family:"Fira Code",monospace;color:var(--text);-webkit-font-smoothing:antialiased}
a{color:inherit}

/* Loader overlay (full-screen) */
#loaderOverlay{
  position:fixed;inset:0;z-index:10000;display:flex;align-items:center;justify-content:center;
  background:linear-gradient(180deg, rgba(2,3,4,0.94), rgba(6,8,10,0.95));
  padding:18px;
}

/* Canvas background for seismic/wave visuals */
#bgCanvas{position:absolute;inset:0;width:100%;height:100%;z-index:0;pointer-events:none}

/* panel */
.panel{
  position:relative;z-index:2;width:100%;max-width:1200px;height:74vh;min-height:420px;border-radius:12px;overflow:hidden;
  background:linear-gradient(180deg, rgba(6,8,10,0.96), rgba(10,12,14,0.94));
  box-shadow:0 30px 80px rgba(0,0,0,0.7), inset 0 1px 0 rgba(255,255,255,0.02);
  display:flex;gap:16px;
}

/* make loader content LTR (terminal-like) even on RTL page */
.panel, .terminal, .log, .side, .file-list { direction: ltr; text-align: left; }

/* terminal area */
.terminal{
  flex:1.4;min-width:360px;padding:16px;display:flex;flex-direction:column;gap:10px;border-right:1px solid rgba(255,255,255,0.02);
  background:linear-gradient(180deg, rgba(0,0,0,0.02), transparent);
  border-top-left-radius:8px;border-bottom-left-radius:8px;
}
.header-line{display:flex;align-items:center;gap:10px}
.title{margin-left:auto;color:var(--muted);font-size:13px}

/* the log area (scrolling) */
.log{
  background:rgba(0,0,0,0.02);flex:1;border-radius:6px;padding:12px;overflow:auto;position:relative;
  box-shadow: inset 0 1px 0 rgba(255,255,255,0.01);
  font-size:13px;line-height:1.45;color:var(--muted);
}
.log-inner{min-height:100%}

/* each log line */
.line{white-space:pre-wrap;margin:4px 0;opacity:0;transform:translateX(-8px);transition:opacity 160ms linear, transform 160ms linear}
.line.show{opacity:1;transform:translateX(0)}
.ts{color:#bfcbd0;display:inline-block;min-width:130px;font-weight:600}
.tag{color:var(--accent);display:inline-block;min-width:120px;font-weight:700}
.ok{color:#9ff2b7}
.warn{color:#ffdba0}
.err{color:#ff9b9b}

/* typed command style */
.typed {color:var(--accent);font-weight:700}
.cursor{display:inline-block;animation:blink 900ms steps(2,end) infinite;margin-left:6px}
@keyframes blink{50%{opacity:0}}

/* jitter effect for realism (subtle) */
@keyframes jitter { 0%{transform:translateX(0)} 50%{transform:translateX(0.4px)} 100%{transform:translateX(0)} }
.line:nth-child(5n){animation:jitter 1400ms ease-in-out infinite;opacity:0.95}

/* right side: status + files */
.side{
  width:360px;min-width:240px;padding:14px;display:flex;flex-direction:column;gap:12px;
}
.status{
  height:160px;border-radius:10px;background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
  display:flex;flex-direction:column;align-items:center;justify-content:center;gap:8px;position:relative;overflow:hidden;
}
.orb{width:88px;height:88px;border-radius:50%;display:grid;place-items:center;font-weight:700;color:var(--accent);font-size:18px;
  box-shadow:0 0 40px rgba(255,179,71,0.06), inset 0 0 18px rgba(255,179,71,0.03)}
.meta{font-size:12px;color:var(--muted);font-family:"Fira Code",monospace;text-align:center}

/* file-list */
.file-list{background:rgba(0,0,0,0.03);padding:8px;border-radius:8px;overflow:auto;flex:1}
.file-item{display:flex;align-items:center;gap:8px;padding:6px 4px;border-radius:6px}
.file-name{flex:1;font-size:13px;color:var(--muted);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.file-progress{width:140px;height:8px;background:rgba(255,255,255,0.03);border-radius:999px;overflow:hidden}
.file-progress .bar{height:100%;width:0;background:linear-gradient(90deg, rgba(255,179,71,0.18), var(--accent));transition:width 160ms linear}

/* bottom overall progress LTR */
.bottom{
  display:flex;align-items:center;gap:12px;padding:10px;border-top:1px solid rgba(255,255,255,0.02)
}
.overall{flex:1;height:12px;background:rgba(255,255,255,0.03);border-radius:999px;overflow:hidden}
.overall .bar{height:100%;width:0;background:linear-gradient(90deg, rgba(255,179,71,0.16), var(--accent));box-shadow:0 6px 30px rgba(255,179,71,0.06);transition:width 120ms linear}
.overall-pct{min-width:56px;text-align:right;color:var(--muted);font-family:"Fira Code",monospace;font-size:13px}

/* fade/hide */
#loaderOverlay.hide{opacity:0;visibility:hidden;transition:opacity 700ms ease, visibility 700ms ease}

/* main app */
#mainApp{position:relative;z-index:1;opacity:0;visibility:hidden;transition:opacity 600ms ease;min-height:100vh;display:flex;align-items:center;justify-content:center;color:var(--text)}
#mainApp.show{opacity:1;visibility:visible}

/* responsive: collapse side panel on small screens */
@media (max-width:900px){
  .panel{flex-direction:column;height:78vh}
  .side{width:100%;min-width:unset;order:2}
  .terminal{order:1;border-right:none;border-bottom:1px solid rgba(255,255,255,0.02)}
  .file-list{max-height:120px}
}
</style>
</head>
<body>

<!-- Loader Overlay -->
<div id="loaderOverlay" role="dialog" aria-label="DASBEM boot loader" aria-modal="true">
  <canvas id="bgCanvas" aria-hidden="true"></canvas>

  <div class="panel" role="document" aria-hidden="false">
    <div class="terminal" aria-live="polite">
      <div class="header-line">
        <div style="flex:1"></div>
        <div class="title">DASBEM · boot sequence (real-mode)</div>
      </div>

      <div class="log" id="log" aria-live="polite" aria-atomic="false">
        <div class="log-inner" id="logInner"></div>
      </div>

      <div class="bottom">
        <div class="overall" aria-hidden="true"><div class="bar" id="overallBar"></div></div>
        <div class="overall-pct" id="overallPct">0%</div>
      </div>
    </div>

    <div class="side" aria-hidden="true">
      <div class="status" role="status" aria-live="polite">
        <div class="orb" id="orb">BEM</div>
        <div class="meta" id="meta">Kernel: boundary-solver · Mode: time-domain</div>
      </div>

      <div class="file-list" id="fileList" aria-live="polite"></div>
    </div>
  </div>
</div>

<!-- Main application to reveal -->
<main id="mainApp" aria-hidden="true">
  <div style="text-align:center">
    <h1 style="font-family:'Fira Code',monospace">The DASBEM Project</h1>
    <p style="color:var(--muted)">صفحهٔ اصلی — لودر کامل شد.</p>
  </div>
</main>

<script>
/* ================= CONFIG ================= */
const TOTAL_MS = 5000; // total loader duration
const logInner = document.getElementById('logInner');
const overallBar = document.getElementById('overallBar');
const overallPct = document.getElementById('overallPct');
const fileListEl = document.getElementById('fileList');
const orb = document.getElementById('orb');
const meta = document.getElementById('meta');
const loaderOverlay = document.getElementById('loaderOverlay');
const mainApp = document.getElementById('mainApp');

const bgCanvas = document.getElementById('bgCanvas');
const ctx = bgCanvas.getContext('2d');

/* ===== helper: iran timestamp ===== */
function iranTimestamp(){
  const now = new Date();
  // build Tehran time by converting via locale then constructing Date
  const dTehran = new Date(now.toLocaleString('en-US', { timeZone: 'Asia/Tehran' }));
  const pad = n => String(n).padStart(2,'0');
  const Y = dTehran.getFullYear(), M = pad(dTehran.getMonth()+1), D = pad(dTehran.getDate());
  const hh = pad(dTehran.getHours()), mm = pad(dTehran.getMinutes()), ss = pad(dTehran.getSeconds());
  return `${Y}-${M}-${D} ${hh}:${mm}:${ss}`;
}

/* ===== realistic files (weights) ===== */
const files = [
  {name:"mesh/semicircle.nod", size:4200, weight:12},
  {name:"mesh/elements.dat", size:13800, weight:12},
  {name:"kernels/bem_kern.bin", size:38400, weight:18},
  {name:"matrices/influence.mtx", size:128000, weight:20},
  {name:"params/runconfig.json", size:1200, weight:4},
  {name:"io/input_wave.srf", size:25600, weight:14},
  {name:"cache/precond.chk", size:8200, weight:8},
  {name:"viz/colormap.cfg", size:900, weight:2}
];
const totalWeight = files.reduce((s,f)=>s+f.weight,0);

// render file list items (LTR)
files.forEach(f=>{
  const el = document.createElement('div'); el.className='file-item';
  el.innerHTML = `<div class="file-name">${f.name}</div><div class="file-progress"><div class="bar" style="width:0%"></div></div>`;
  fileListEl.appendChild(el);
  f._el = el; f._bar = el.querySelector('.bar'); f._progress = 0;
  // speed factor: simulate I/O vs CPU (0.6..1.8)
  f._speed = 0.6 + Math.random()*1.6;
});

/* realistic log templates */
const LOG_TEMPLATES = [
  "[BOOT] Performing power-on self test",
  "[CORE] Initializing boundary-engine modules",
  "[IO] Opening data store: /var/dasbem/data",
  "[MESH] Loading node coordinates ({N} nodes)",
  "[MESH] Loading element connectivity ({E} elems)",
  "[KERN] Validating kernel signatures",
  "[CACHE] Restoring preconditioner blocks ({B} bytes)",
  "[SOLVER] Assembling influence matrix (this may take time)",
  "[SOLVER] Factorizing block row {r}/{R}",
  "[PAR] Spawning solver workers (threads={T})",
  "[CHK] CFL/stability checks passed",
  "[ANL] Estimating modal frequencies...",
  "[IO] Streaming input waveform frames",
  "[NET] License handshake completed",
  "[DONE] Module {M} ready"
];

const rnd = (min,max)=> Math.floor(Math.random()*(max-min+1))+min;
const choose = arr => arr[Math.floor(Math.random()*arr.length)];
function craftLog(){
  let t = choose(LOG_TEMPLATES);
  t = t.replace("{N}", rnd(1200,8192));
  t = t.replace("{E}", rnd(600,4096));
  t = t.replace("{B}", rnd(1024,65536));
  t = t.replace("{r}", rnd(1,9999));
  t = t.replace("{R}", rnd(1000,9999));
  t = t.replace("{T}", rnd(4,16));
  t = t.replace("{M}", choose(["influence","mesh","io","parallel","precond"]));
  return t;
}

/* append log with iran timestamp */
function appendLog(text, level="info"){
  const d = document.createElement('div');
  d.className = 'line';
  const ts = iranTimestamp();
  d.innerHTML = `<span class="ts">${ts}</span> <span class="tag">${escapeHtml(text)}</span>`;
  logInner.appendChild(d);
  // bound DOM size
  while(logInner.children.length > 900) logInner.removeChild(logInner.firstChild);
  // show with subtle stagger
  requestAnimationFrame(()=> d.classList.add('show'));
  // auto-scroll
  const parent = logInner.parentElement;
  parent.scrollTop = parent.scrollHeight;
}

/* typed command for realism */
function typedCommand(text, avgDelay=12){
  return new Promise(resolve=>{
    const d = document.createElement('div'); d.className = 'line';
    const ts = iranTimestamp();
    d.innerHTML = `<span class="ts">${ts}</span> <span class="tag">[EXEC]</span> <span class="typed"></span><span class="cursor">▌</span>`;
    logInner.appendChild(d);
    const typed = d.querySelector('.typed');
    let i=0;
    (function step(){
      if(i<=text.length){
        typed.textContent = text.slice(0,i);
        i++;
        // scroll
        logInner.parentElement.scrollTop = logInner.parentElement.scrollHeight;
        setTimeout(step, avgDelay + Math.random()*8);
      } else {
        d.querySelector('.cursor').remove();
        d.innerHTML = `<span class="ts">${ts}</span> <span class="tag">[EXEC]</span> ${escapeHtml(text)} <span class="ok"> · done</span>`;
        requestAnimationFrame(()=> d.classList.add('show'));
        resolve();
      }
    })();
  });
}

function escapeHtml(s){ return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

/* orchestrate realistic behavior */
function startLoader(totalMs){
  const start = performance.now();
  const end = start + totalMs;

  // schedule deterministic high-level logs for realism
  const schedule = [
    {t:0.02,msg:"Performing power-on self test"},
    {t:0.09,msg:"Detecting CPU & memory modules"},
    {t:0.16,msg:"Mounting dataset repository"},
    {t:0.24,msg:"Reading mesh headers"},
    {t:0.33,msg:"Loading kernel modules"},
    {t:0.46,msg:"Initializing parallel workers"},
    {t:0.60,msg:"Assembling influence operators"},
    {t:0.78,msg:"Finalizing solver pipeline"},
    {t:0.90,msg:"Launching web interface"}
  ];

  schedule.forEach(s => setTimeout(()=> appendLog(s.msg), Math.max(10, Math.floor(s.t * totalMs))));

  // initial seed logs
  appendLog("Power check · PASS");
  appendLog("Detecting CPU cores: " + (navigator.hardwareConcurrency || "unknown"));
  appendLog("Mounting data store");

  // typed init command for authenticity
  setTimeout(()=> typedCommand("dasbem --init --mode=time-domain --threads=8"), 120);

  // dynamic tick: updates files, produce logs, compute weighted overall progress
  function tick(){
    const now = performance.now();
    const elapsed = now - start;
    const timeRatio = Math.min(1, elapsed / totalMs);

    // update each file progress toward completion using weight and speed
    files.forEach((f, idx)=>{
      // desired completion factor = timeRatio * (f.weight/avg) * speed
      const desired = Math.min(100, Math.round(timeRatio * 100 * (f.weight/(totalWeight/1.6)) * f._speed));
      // smooth growth and small jitter
      f._progress = Math.max(f._progress, Math.min(100, desired - idx*1 + Math.round(Math.sin(elapsed/120 + idx)*4)));
      f._bar.style.width = Math.max(0, Math.min(100, f._progress)) + '%';
    });

    // compute weighted overall progress (realistic)
    const weighted = files.reduce((s,f)=> s + (Math.min(100,f._progress) * f.weight), 0) / totalWeight;
    // blend with time ratio to ensure finish near TOTAL_MS
    const overall = Math.min(100, Math.round(weighted * 0.96 + timeRatio * 100 * 0.04));
    overallBar.style.width = overall + '%';
    overallPct.textContent = overall + '%';

    // orb shows approximate nodes (realistic evolving number)
    const nodes = 1200 + Math.round((overall/100) * 7000);
    orb.textContent = nodes;

    // produce logs: denser earlier, smaller bursts near end
    const burst = Math.max(1, Math.round( 1 + (1 - timeRatio) * 8 + Math.random()*4 ));
    for(let i=0;i<burst;i++){
      if(Math.random() < 0.12) appendLog(craftLog());
      else if(Math.random() < 0.08) appendLog("IO: read " + rnd(1024,65536) + " bytes from /data/waves.bin");
      else appendLog(choose([
        "MESH: loaded node block " + rnd(1,13) + "/13",
        "SOLVER: factorizing block " + rnd(1,24) + "/24",
        "CACHE: preconditioner warm-up " + rnd(10,98) + "%",
        "PAR: worker wt-" + rnd(1,12) + " heartbeat OK",
        "IO: flushed buffer to disk"
      ]));
      // limit lines
      if(logInner.children.length > 1200) break;
    }

    // continue or finalize
    if(now < end - 120){
      setTimeout(tick, Math.max(10, 22 - Math.round(timeRatio*12)));
    } else {
      // finalize quickly
      files.forEach(f=> { f._progress = 100; f._bar.style.width = '100%'; });
      overallBar.style.width = '100%'; overallPct.textContent = '100%';
      appendLog("[FINALIZE] flushing buffers · ok");
      appendLog("[STATUS] System ONLINE");
      // small delay then finish
      setTimeout(()=> finish(), 260);
    }
  }

  // quick early flood
  setTimeout(()=> { for(let i=0;i<6;i++) appendLog(craftLog()); }, 40);
  tick();
}

/* finish: fade overlay and reveal main */
function finish(){
  loaderOverlay.classList.add('hide');
  setTimeout(()=> {
    loaderOverlay.remove();
    mainApp.classList.add('show');
  }, 720);
}

/* ================= background seismic canvas ================= */
(function(){
  const dpr = window.devicePixelRatio || 1;
  function resize(){ bgCanvas.width = innerWidth * dpr; bgCanvas.height = innerHeight * dpr; bgCanvas.style.width = innerWidth + 'px'; bgCanvas.style.height = innerHeight + 'px'; ctx.setTransform(dpr,0,0,dpr,0,0); }
  resize(); window.addEventListener('resize', resize);

  let t0 = performance.now();
  function draw(now){
    const t = (now - t0)/1000;
    ctx.clearRect(0,0,innerWidth,innerHeight);

    // ambient radial from source (left-bottom)
    const gx = ctx.createRadialGradient(innerWidth*0.32, innerHeight*0.72, 10, innerWidth*0.32, innerHeight*0.72, Math.max(innerWidth,innerHeight));
    const alpha = 0.012 + 0.02*Math.sin(t*1.2);
    gx.addColorStop(0, `rgba(255,179,71,${alpha})`); gx.addColorStop(1, 'rgba(0,0,0,0)');
    ctx.fillStyle = gx; ctx.fillRect(0,0,innerWidth,innerHeight);

    // semicircular wavefronts - intensity scales with overall pct
    const overall = parseInt(document.getElementById('overallPct')?.textContent || '0') || 0;
    const maxR = Math.min(innerWidth, innerHeight) * 0.9;
    const waves = 6;
    for(let w=0; w<waves; w++){
      const phase = t*1.6 - w*0.36;
      const r = Math.abs(((phase % 3) / 3)) * maxR * (0.22 + w*0.10);
      ctx.beginPath();
      ctx.arc(innerWidth*0.32, innerHeight*0.72, r, Math.PI, 2*Math.PI);
      const a = 0.01 + Math.max(0, (overall/100) * 0.07 * (1 - w/waves));
      ctx.strokeStyle = `rgba(255,179,71,${a})`;
      ctx.lineWidth = 1 + (1 - w/waves)*1.8;
      ctx.stroke();
    }

    // particles for IO/compute, density decreases as overall grows
    const density = 48 + Math.round((100 - overall) * 0.6);
    for(let i=0;i<density;i++){
      const x = innerWidth * (0.12 + Math.random()*0.7);
      const y = innerHeight * (0.35 + Math.random()*0.45);
      ctx.beginPath();
      ctx.fillStyle = `rgba(255,170,80,${0.01 + Math.random()*0.04})`;
      ctx.arc(x + Math.sin(t*(0.3 + i%3))*6, y + Math.cos(t*(0.4 + i%5))*4, Math.random()*1.6, 0, Math.PI*2);
      ctx.fill();
    }

    requestAnimationFrame(draw);
  }
  requestAnimationFrame(draw);
})();

/* ===== start loader ===== */
setTimeout(()=> startLoader(TOTAL_MS), 80);
</script>
</body>
</html>
